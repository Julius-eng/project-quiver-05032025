# Status  

`Valid`

# Project Description
Compass setup and verification for PT3's first two builds using two external magnetometers—MatekSys GNSS M9N-G4-3100 and Wren Mini.  
The Pix32 v6 internal magnetometer is disabled (since it's not reliable enough for flight). Target outcomes: stable EKF heading in both open-field and near-building environments, <5° yaw step at liftoff, and no compass-related errors.

---

# Methodology

### 1) Orientation 
Set the physical orientation for each external compass exactly as mounted. If the actual orientation is not known, the ArduPilot guide for advanced compass setup would be helpful:  
<https://ardupilot.org/copter/docs/common-compass-setup-advanced.html#orientation>  
Confirm with a quick sanity check from artificial horizon (gentle roll/pitch while monitoring axis responses) to avoid calibrating a mis-oriented sensor.

### 2) Calibration (Onboard)
Run Onboard Mag Calibration well away from magnetic interference:  
<https://ardupilot.org/copter/docs/common-compass-calibration-in-mission-planner.html#onboard-calibration>

- Inside a barn: yielded mediocre results (likely due to ferrous structure, wiring, tools).  
- Away from the barn: significantly better and repeatable.

Large Vehicle MagCal was evaluated; on this airframe, standard Onboard Cal outdoors produced superior results and was adopted.

### 3) Quick flight check
Perform a short manual check (POSHOLD/LOITER) after calibration: confirm no toilet-bowling, no unusual yaw drift, and no mag-related warnings.

### 4) MagFit — data collection
Collected datasets for both versions. In the U.S. version, a manual 6 minutes flight containing all step inputs, throttle sweeps, 360 turns and drawing circles has been used as MagFit data. In Germany build, auto figure-8 mission generated by the MagFit helper script has been used. (repeatable and efficient):  
  <https://discuss.ardupilot.org/t/scripted-magfit-flightpath-generation/97536>

Both of them yielded good data.


### 5) MagFit 

MagFit was executed via WebTools with Battery1 current offsets + scale enabled:

<https://ardupilot.org/copter/docs/common-magfit.html#using-webtools-magfit>

Classic motor compensation was not applied because the available dataset did not provide sufficient coverage for that term; fitting it would likely produce a poor/unstable model. A dedicated, broader current-sweep dataset would be required before enabling that option.

  

### 6) Priority assignment (after MagFit)

Priority was chosen after reviewing MagFit error metrics. Mateksys gave less Mean Gaussian Error values.

-  Germany: MatekSys was set as primary from the beginning; performance was excellent and remained so.

-  United States: heading performance improved noticeably after switching MatekSys to primary (Wren Mini secondary), consistent with the error comparison.
---

# Results and Deliverables

### Performance
- Near buildings vs open field: No observable difference; building EMI did not impact behavior with this setup.  
- Takeoff yaw reset: < 5° change at liftoff (within target).  
- Health: No compass-related errors in pre-arm or in flight in both builds.

### Configuration outcomes
- Pix32 v6 internal magnetometer disabled.  
- MatekSys primary / Wren Mini secondary, priority chosen after MagFit in each region.  
- MagFit applied with Battery1 current offsets + scale; OFS + DIA/ODI/SCALE solved.

### Final Performance
- Pre-arm: no mag field anomaly, offsets high, or inconsistent compasses messages.  
- In-flight: no EKF lane switches attributable to the magnetometer; clean innovations; no LOITER yaw drift/oscillation.  
- Ground truth vs GCS yaw aligned within a few degrees at rest.

---

# Remarks 
- Re-run calibration and MagFit after any sensor relocation, harness reroute, or power-system change.
